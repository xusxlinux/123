## 1.服务器说明
#### 我这里使用的是高可用方案,如果使用单点,只需要一台master就行
|系统类型  |外网IP地址   |外网IP地址 |节点角色|主机名       |CPU   |内存  |
|:-------: |:-----:      |:-----:    |:----:  |:----:       |:----:|:----:|


## 2.系统设置(所有节点 或者 使用内外DNS域名解析)
#### 2.1 主机名
主机名必须每个节点不一样，并且保证所有节点之间可以通过hostname互相访问
```
# 设置主机名
hostnamectl set-hostname k8s-master-01
hostnamectl set-hostname k8s-node-01

# 配置host或者(bind9),使节点之间可以通过hostname互相访问
vim /etc/hosts
```

#### 2.2 安装依赖包
```
# 更新yum
yum update

# 替换好最新源后, 更新缓存
yum clean all
yum makecache fast

# 安装依赖包
yum groupinstall -y "base" "Development tools"

yum install conntrack sysstat ipvsadm ipset jq curl wget iptables iptables-services nfs-utils bind bind-utils libseccomp libffi-devel -y
yum install net-tools vim lrzsz tree screen lsof tcpdump nc mtr nmap openssl openssl-devel bash-completion readline-devel zlib-devel bzip2-devel -y

# nginx相关
yum install gcc gcc-c++ pcre pcre-devel bzip2-devel zlib-devel glibc httpd-tools autoconf automake -y
yum install lua-devel GeoIP-devel gd-devel -y

# JDK相关
yum provides java
yum install java-1.8.0-openjdk-1.8.0.222.b03-1.el7.i686 -y
```

#### 2.3 关闭防火墙、swap、重置iptables
```
# 关闭防火墙
systemctl stop firewalld && systemctl disable firewalld
systemctl stop NetworkManager && systemctl disable NetworkManager

# 重置iptables
iptables -F && iptables -X && iptables -F -t nat && iptables -X -t nat && iptables -P FORWARD ACCEPT

# 关闭swap
swapoff -a

# 关闭selinux
setenforce 0

# 关闭dnsmasq(否则可能导致docker容器无法解析域名)
service dnsmasq stop && systemctl disable dnsmasq
```

#### 2.4 系统参数设置
``` shell
# 设置历史命令
echo 'export HISTTIMEFORMAT="%y-%m-%d %H:%M:%S "' >> /etc/profile
sed -i "s#HISTSIZE=1000#HISTSIZE=5000#g" /etc/profile
source /etc/profile

# 设置资源限制,开启最大连接数
echo "root soft nofile 65535" >> /etc/security/limits.d/20-nofile.conf
echo "root hard nofile 65535" >> /etc/security/limits.d/20-nofile.conf
echo "* soft nofile 65535" >> /etc/security/limits.d/20-nofile.conf
echo "* hard nofile 65535" >> /etc/security/limits.d/20-nofile.conf

# 修改线程默认栈空间大小方法
echo "* soft stack 102400" >> /etc/security/limits.conf

# 修改系统最大线程数
sed -i.bak '5,6d' /etc/security/limits.d/20-nproc.conf
sed -i '3a *    -     nproc   65535' /etc/security/limits.d/20-nproc.conf
sed -i '4a root soft  nproc  unlimited' /etc/security/limits.d/20-nproc.conf
sed -i '5a root hard  nproc  unlimited' /etc/security/limits.d/20-nproc.conf

cp /etc/systemd/system.conf /etc/systemd/system.conf.bak
sed -i '/^#DefaultLimitNOFILE=/aDefaultLimitNOFILE=655350' /etc/systemd/system.conf
sed -i '/^#DefaultLimitNPROC=/aDefaultLimitNPROC=655350' /etc/systemd/system.conf
sed -i '/^#DefaultLimitMEMLOCK=/aDefaultLimitMEMLOCK=infinity' /etc/systemd/system.conf

# 需要重启
reboot
```

#### 2.5 时间同步
``` shell
mv /etc/localtime{,.bak}
ln -s /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
ntpdate cn.pool.ntp.org
```

#### 2.6 英文字符集
``` shell
cp /etc/sysconfig/i18n /etc/sysconfig/i18n.ori
echo 'LANG="en_US.UTF-8"'  >/etc/sysconfig/i18n 
source /etc/sysconfig/i18n
echo $LANG
```

#### 2.7 ssh连接速度慢优化
``` shell
sed -i.bak 's@#UseDNS yes@UseDNS no@g;s@^GSSAPIAuthentication yes@GSSAPIAuthentication no@g'  /etc/ssh/sshd_config
systemctl restart sshd
```

#### 2.8 关闭selinux
``` shell
sed -i.bak 's/SELINUX=enforcing/SELINUX=disabled/' /etc/selinux/config
grep SELINUX=disabled /etc/selinux/config 
setenforce 0
getenforce
```

#### 2.9 创建非管理员用户
``` shell
useradd xusx
echo 123456|passwd --stdin xusx

\cp /etc/sudoers /etc/sudoers.ori
echo "xusx  ALL=(ALL) NOPASSWD: ALL " >>/etc/sudoers

visudo -c
```

#### 2.10 免密登陆
``` shell
# 创建密钥文件
ssh-keygen

# 复制SSH密钥到目标主机，开启无密码SSH登录
ssh-copy-id -i  ~/.ssh/id_rsa.pub root@目标服务器地址

# 远程登陆
ssh 用户名@目标服务器地址
```

#### 2.11 磁盘挂载
``` shell
# 所有有新添加磁盘的服务器挂载 (创建一个新的分区 "n", 默认是主分区 "p", 默认是 "1" 到最后, 最后把分区表写入 "w")
fdisk /dev/vdb

# 对分区格式化, 格式为xfs
mkfs.xfs /dev/vdb1

# 查看磁盘的UUID
blkid /dev/vdb1

# 加入开启挂载(第一个0表示备份, 第二个0表示动时不检查)
vim /etc/fstab

# 挂载
mount -a

# 挂载方式 (mount -t 类型 -o 挂接方式 源路径 目标路径)
mount -t xfs -o rw /dev/sdb1 /data
```

#### 2.12 禁用22端口
``` shell
# 查看是用ssh或者是sshd启用22端口的
netstat -lntup | grep 22


# 找到#Port 22的位置，添加22和新端口，如下：
vim /etc/ssh/sshd_config
Port 22
Port 50022

systemctl restart sshd


# 向selinux中添加/删除新的连接端口50022
semanage port -a -t ssh_port_t -p tcp 50022
semanage port -d -t ssh_port_t -p tcp 50022

# 查看当前SELinux运行的端口
semanage port -l | grep ssh

# 在iptables中禁用22端口, 添加放行50022端口
-A INPUT -p tcp -m state --state NEW -m tcp --dport 50022 -j ACCEPT
```

#### 2.13 使用pem密钥的方式登录服务器
``` shell
# 创建密钥文件
ssh-keygen -t rsa -b 4096 -C "xusx@example.com" -f ~/.ssh/id_rsa
cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys

vim /etc/ssh/sshd_config
PubkeyAuthentication yes
```

#### 2.14 禁止root账户密码登录
``` shell
# 禁止 root 用户使用密码进行远程登录

vim /etc/ssh/sshd_config
PermitRootLogin prohibit-password
```

